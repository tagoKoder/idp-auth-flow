<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Open Patient App</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif; }
    body { margin: 0; padding: 24px; background:#0b0c10; color:#fff; display:grid; place-items:center; min-height:100svh; }
    .card { width:min(520px, 92vw); background:#15171c; border-radius:18px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 10px; font-size:1.35rem; }
    p { opacity:.85; line-height:1.45; }
    .actions { margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; }
    button, a.btn { border:0; border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer; text-decoration:none; }
    .primary { background:#ff6a3d; color:#111; }
    .ghost { background:#23262f; color:#fff; }
    .hidden { display:none; }
    .note { font-size:.9rem; opacity:.8; margin-top:8px; }
    code { background:#23262f; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
<div class="card">
    <h1>Opening <b>Patient App</b>…</h1>
    <p>If it doesn't open automatically, tap the <b>Open the app</b> button. If the app is not installed, you will see help options.</p>

    <div class="actions">
        <button id="openBtn" class="primary">Open the app</button>
        <a id="manualLink" class="ghost" href="com.clinic.patient://oauthredirect">Try again</a>
    </div>

    <div id="fallback" class="hidden">
        <p class="note">We couldn't open the app. Possible reasons:
            <br>• The app is not installed <span id="androidOnly" class="hidden">(Android: you will be sent to the help URL)</span>.
            <br>• You are in an embedded browser (some block app openings).
            <br>• You haven't registered the passkey on this domain yet.
        </p>
        <div class="actions">
            <a id="helpLink" class="ghost" href="#">See help</a>
            <button id="copyBtn" class="ghost">Copy app link</button>
        </div>
    </div>

    <p class="note">App link: <code>com.clinic.patient://oauthredirect</code></p>
    <noscript><p class="note">Enable JavaScript and tap the link above.</p></noscript>
</div>

  <script>
    // === Config ===
    const SCHEME_URL = "com.clinic.patient://oauthredirect";
    const ANDROID_PACKAGE = "com.clinic.patient"; // adjust if your package differs
    // Help page (can be a markdown or a simple landing page)
    const HELP_URL = "https://app-paciente.santiago-tumbaco.lat/ayuda";

    // === Utils ===
    const isAndroid = /Android/i.test(navigator.userAgent);
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const openBtn = document.getElementById("openBtn");
    const manualLink = document.getElementById("manualLink");
    const fallback = document.getElementById("fallback");
    const helpLink = document.getElementById("helpLink");
    const androidOnly = document.getElementById("androidOnly");
    const copyBtn = document.getElementById("copyBtn");

    helpLink.href = HELP_URL;
    if (isAndroid) androidOnly.classList.remove("hidden");

    async function copyScheme() {
      try { await navigator.clipboard.writeText(SCHEME_URL); openBtn.textContent = "Copiado ✓"; }
      catch (_) { /* ignored */ }
    }

    // Cancel fallback if the browser loses visibility (the app was opened)
    function cancelOnHide(timerId) {
      const handler = () => { if (document.hidden) clearTimeout(timerId); };
      document.addEventListener("visibilitychange", handler, { once: true });
    // iOS/Safari: pagehide also helps
      window.addEventListener("pagehide", () => clearTimeout(timerId), { once: true });
    }

    function launchApp() {
    // Attempt 1: Android Chrome supports intent:// with native fallback
      if (isAndroid) {
        const intentUrl =
          `intent://oauthredirect#Intent;scheme=com.clinic.patient;package=${ANDROID_PACKAGE}` +
          `;S.browser_fallback_url=${encodeURIComponent(HELP_URL)};end`;
        window.location.href = intentUrl;
        const t = setTimeout(() => fallback.classList.remove("hidden"), 1500);
        cancelOnHide(t);
        return;
      }

    // Attempt 2: iOS and others → custom scheme by gesture
      window.location.href = SCHEME_URL;
      const t = setTimeout(() => fallback.classList.remove("hidden"), 1200);
      cancelOnHide(t);
    }

    openBtn.addEventListener("click", launchApp);
    copyBtn.addEventListener("click", copyScheme);

    // Optional: also try on load (some browsers require a gesture; that's why we show a button)
    // launchApp();
  </script>
</body>
</html>
